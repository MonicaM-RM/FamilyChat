<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FamilyChat</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Chat familiar en tiempo real">
    <meta name="theme-color" content="#111B21">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FamilyChat">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons para iOS -->
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --wa-dark-green: #111B21;
            --wa-teal: #00A884;
            --wa-teal-dark: #008069;
            --wa-light-green: #D9FDD3;
            --wa-header: #202C33;
            --wa-chat-bg: #0B141A;
            --wa-input-bg: #2A3942;
            --wa-border: #222D34;
            --wa-text: #E9EDEF;
            --wa-text-secondary: #8696A0;
            --wa-bubble-out: #005C4B;
            --wa-bubble-in: #202C33;
            --wa-unread: #00A884;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            background: var(--wa-dark-green);
            touch-action: manipulation;
        }

        body {
            min-height: 100vh;
            min-height: 100dvh;
        }

        /* Auth Styles */
        .container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(180deg, var(--wa-teal-dark) 0%, var(--wa-teal-dark) 30%, var(--wa-dark-green) 30%);
            padding: 20px;
        }

        .auth-container {
            background: var(--wa-header);
            border-radius: 8px;
            padding: 35px 30px;
            width: 100%;
            max-width: 360px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }

        .auth-container h1 {
            text-align: center;
            color: var(--wa-text);
            margin-bottom: 6px;
            font-size: 1.6em;
            font-weight: 500;
        }

        .auth-container .subtitle {
            text-align: center;
            color: var(--wa-text-secondary);
            margin-bottom: 25px;
            font-size: 0.9em;
        }

        .auth-container .logo {
            text-align: center;
            font-size: 3em;
            margin-bottom: 12px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--wa-teal);
            font-weight: 400;
            font-size: 0.85em;
        }

        .form-group input {
            width: 100%;
            padding: 12px 14px;
            border: none;
            border-bottom: 2px solid var(--wa-border);
            font-size: 16px;
            background: transparent;
            color: var(--wa-text);
            transition: border-color 0.3s;
        }

        .form-group input::placeholder {
            color: var(--wa-text-secondary);
        }

        .form-group input:focus {
            outline: none;
            border-bottom-color: var(--wa-teal);
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 24px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--wa-teal);
            color: var(--wa-dark-green);
        }

        .btn-primary:active {
            background: var(--wa-teal-dark);
        }

        .btn-secondary {
            background: transparent;
            color: var(--wa-teal);
            border: 1px solid var(--wa-teal);
            margin-top: 10px;
        }

        .btn-danger {
            background: #EA4335;
            color: white;
        }

        .btn-link {
            background: none;
            border: none;
            color: #EA4335;
            cursor: pointer;
            font-size: 13px;
            margin-top: 18px;
            opacity: 0.9;
            width: auto;
            padding: 0;
        }

        .error-msg {
            background: rgba(234, 67, 53, 0.15);
            color: #FF6B6B;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 14px;
            text-align: center;
            display: none;
            font-size: 13px;
        }

        .success-msg {
            background: rgba(0, 168, 132, 0.15);
            color: var(--wa-teal);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 14px;
            text-align: center;
            display: none;
            font-size: 13px;
        }

        /* Chat App - Full screen */
        .chat-app {
            display: none;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            background: var(--wa-dark-green);
            overflow: hidden;
            flex-direction: column;
        }

        /* Main Header */
        .chat-header {
            background: var(--wa-header);
            color: var(--wa-text);
            padding: 10px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 56px;
            flex-shrink: 0;
        }

        .chat-header h2 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1em;
            font-weight: 500;
        }

        .chat-header .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header .user-name {
            font-weight: 400;
            font-size: 0.9em;
            color: var(--wa-text-secondary);
        }

        .btn-logout {
            background: transparent;
            color: var(--wa-text-secondary);
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.1);
            color: var(--wa-text);
        }

        .btn-toggle-contacts {
            background: none;
            border: none;
            color: var(--wa-text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s;
            display: none;
        }

        .btn-toggle-contacts:hover {
            background: rgba(255,255,255,0.1);
        }

        .chat-body {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* Contacts List - Full height */
        .contacts-sidebar {
            width: 100%;
            background: var(--wa-dark-green);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-container {
            display: flex;
            background: var(--wa-header);
            flex-shrink: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 14px 10px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 400;
            font-size: 14px;
            color: var(--wa-text-secondary);
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: var(--wa-teal);
            border-bottom-color: var(--wa-teal);
        }

        .contacts-header {
            padding: 18px 20px 10px;
            font-weight: 500;
            color: var(--wa-teal);
            font-size: 15px;
            flex-shrink: 0;
        }

        #contactsList {
            flex: 1;
            overflow-y: auto;
        }

        .contact-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid var(--wa-border);
        }

        .contact-item:hover {
            background: var(--wa-header);
        }

        .contact-item.active {
            background: var(--wa-input-bg);
        }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--wa-teal-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            font-size: 20px;
            flex-shrink: 0;
        }

        .contact-info {
            flex: 1;
            min-width: 0;
        }

        .contact-name {
            font-weight: 400;
            margin-bottom: 2px;
            color: var(--wa-text);
            font-size: 16px;
        }

        .contact-status {
            font-size: 13px;
            color: var(--wa-text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unread-badge {
            background: var(--wa-unread);
            color: var(--wa-dark-green);
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .no-users-msg {
            text-align: center;
            padding: 50px 25px;
            color: var(--wa-text-secondary);
        }

        .no-users-msg p:first-child {
            font-size: 16px;
            margin-bottom: 8px;
        }

        /* Chat Area - Full screen */
        .chat-area {
            display: none;
            flex-direction: column;
            background: var(--wa-chat-bg);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
        }

        .chat-area.active {
            display: flex;
        }

        .chat-area-header {
            padding: 10px 16px;
            background: var(--wa-header);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
            height: 56px;
        }

        .btn-back {
            background: none;
            border: none;
            color: var(--wa-text-secondary);
            font-size: 22px;
            cursor: pointer;
            padding: 6px;
            margin-right: 4px;
        }

        .chat-area-header .contact-avatar {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }

        .chat-area-header .contact-info {
            flex: 1;
        }

        .chat-area-header .contact-name {
            font-size: 16px;
            font-weight: 500;
        }

        .chat-area-header .contact-status {
            font-size: 12px;
            color: var(--wa-text-secondary);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 5L35 15L45 15L37 23L40 33L30 27L20 33L23 23L15 15L25 15Z' fill='%23ffffff' fill-opacity='0.02'/%3E%3C/svg%3E") var(--wa-chat-bg);
        }

        .message {
            max-width: 85%;
            padding: 6px 10px;
            border-radius: 8px;
            position: relative;
            margin: 1px 0;
        }

        .message-sent {
            align-self: flex-end;
            background: var(--wa-bubble-out);
            color: var(--wa-text);
            border-top-right-radius: 0;
        }

        .message-received {
            align-self: flex-start;
            background: var(--wa-bubble-in);
            color: var(--wa-text);
            border-top-left-radius: 0;
        }

        .message-sender {
            font-size: 12px;
            font-weight: 500;
            color: var(--wa-teal);
            margin-bottom: 2px;
        }

        .message-text {
            line-height: 1.35;
            font-size: 14.5px;
            word-wrap: break-word;
        }

        .message-time {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            text-align: right;
            margin-top: 2px;
            margin-left: 10px;
            float: right;
            margin-bottom: -4px;
        }

        .message-input-container {
            padding: 8px 10px;
            background: var(--wa-header);
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }

        .message-input {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 24px;
            font-size: 15px;
            outline: none;
            background: var(--wa-input-bg);
            color: var(--wa-text);
        }

        .message-input::placeholder {
            color: var(--wa-text-secondary);
        }

        .btn-send {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--wa-teal);
            color: var(--wa-dark-green);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .btn-send:active {
            background: var(--wa-teal-dark);
        }

        .no-chat-selected {
            flex: 1;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--wa-text-secondary);
            padding: 20px;
            background: var(--wa-chat-bg);
        }

        .no-chat-selected .icon {
            font-size: 60px;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        .no-chat-selected h3 {
            color: var(--wa-text);
            font-weight: 400;
            margin-bottom: 8px;
        }

        /* Mobile - Default (contacts full screen, chat overlays) */
        @media (max-width: 768px) {
            .btn-toggle-contacts {
                display: none;
            }

            .contacts-sidebar {
                width: 100%;
            }

            .chat-area {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
            }

            /* === DISE√ëO GRANDE PARA M√ìVIL === */
            
            /* Header principal */
            .chat-header {
                height: 70px;
                padding: 14px 20px;
            }

            .chat-header h2 {
                font-size: 1.5em;
            }

            .btn-logout {
                font-size: 16px;
                padding: 12px 18px;
            }

            .user-name {
                font-size: 15px !important;
            }

            /* Pesta√±as */
            .tab-btn {
                padding: 18px 12px;
                font-size: 17px;
                font-weight: 500;
            }

            /* Header de contactos */
            .contacts-header {
                padding: 22px 20px 14px;
                font-size: 18px;
            }

            /* Lista de contactos */
            .contact-item {
                padding: 18px 20px;
                gap: 18px;
            }

            .contact-avatar {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }

            .contact-name {
                font-size: 19px;
                font-weight: 500;
            }

            .contact-status {
                font-size: 15px;
                margin-top: 3px;
            }

            .unread-badge {
                min-width: 26px;
                height: 26px;
                font-size: 14px;
                border-radius: 13px;
            }

            /* Mensaje de no usuarios */
            .no-users-msg {
                padding: 60px 30px;
            }

            .no-users-msg p:first-child {
                font-size: 20px;
            }

            /* Header del chat */
            .chat-area-header {
                height: 70px;
                padding: 14px 18px;
                gap: 16px;
            }

            .btn-back {
                font-size: 30px;
                padding: 8px;
            }

            .chat-area-header .contact-avatar {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .chat-area-header .contact-name {
                font-size: 19px;
                font-weight: 500;
            }

            .chat-area-header .contact-status {
                font-size: 14px;
            }

            /* √Årea de mensajes */
            .messages-container {
                padding: 16px 18px;
                gap: 4px;
            }

            .message {
                padding: 10px 14px;
                border-radius: 12px;
                max-width: 88%;
            }

            .message-text {
                font-size: 17px;
                line-height: 1.45;
            }

            .message-sender {
                font-size: 14px;
                margin-bottom: 4px;
            }

            .message-time {
                font-size: 13px;
            }

            /* Input de mensaje */
            .message-input-container {
                padding: 14px 16px;
                gap: 14px;
            }

            .message-input {
                padding: 14px 20px;
                font-size: 17px;
                border-radius: 26px;
            }

            .btn-send {
                width: 54px;
                height: 54px;
                font-size: 22px;
            }

            /* Auth containers para m√≥vil */
            .auth-container {
                padding: 40px 28px;
            }

            .auth-container .logo {
                font-size: 4em;
                margin-bottom: 16px;
            }

            .auth-container h1 {
                font-size: 2em;
                margin-bottom: 8px;
            }

            .auth-container .subtitle {
                font-size: 1.05em;
                margin-bottom: 30px;
            }

            .form-group {
                margin-bottom: 20px;
            }

            .form-group label {
                font-size: 0.95em;
                margin-bottom: 8px;
            }

            .form-group input {
                padding: 14px 16px;
                font-size: 17px;
            }

            .btn {
                padding: 15px;
                font-size: 17px;
                border-radius: 28px;
            }

            .btn-secondary {
                margin-top: 14px;
            }

            .btn-link {
                font-size: 15px;
                margin-top: 24px;
            }

            .error-msg, .success-msg {
                padding: 14px;
                font-size: 15px;
                margin-bottom: 18px;
            }
        }

        /* Tablet & Desktop */
        @media (min-width: 769px) {
            .chat-body {
                max-width: 1400px;
                margin: 0 auto;
                width: 100%;
            }

            .contacts-sidebar {
                width: 400px;
                max-width: 30%;
                border-right: 1px solid var(--wa-border);
                flex-shrink: 0;
            }

            .chat-area {
                position: relative;
                flex: 1;
                display: flex;
            }

            .chat-area.active {
                display: flex;
            }

            .no-chat-selected {
                display: flex;
            }

            .btn-back {
                display: none;
            }

            .chat-header .user-name {
                display: inline;
            }
        }

        @media (min-width: 1200px) {
            .contacts-sidebar {
                width: 420px;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div class="container" id="authContainer">
        <div class="auth-container" id="loginForm">
            <div class="logo">‚òéÔ∏è</div>
            <h1>FamilyChat</h1>
            <p class="subtitle">Conecta con tu familia</p>
            
            <div class="error-msg" id="loginError"></div>
            <div class="success-msg" id="loginSuccess"></div>
            
            <div class="form-group">
                <label for="loginName">Nombre de usuario</label>
                <input type="text" id="loginName" placeholder="Tu nombre" maxlength="20">
            </div>
            
            <div class="form-group">
                <label for="loginPin">PIN (4 d√≠gitos)</label>
                <input type="password" id="loginPin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" pattern="[0-9]*" inputmode="numeric">
            </div>
            
            <button class="btn btn-primary" onclick="login()">Iniciar Sesi√≥n</button>
            <button class="btn btn-secondary" onclick="showRegister()">Crear Cuenta Nueva</button>
            <button class="btn-link" onclick="showDeleteAccount()">Eliminar una cuenta</button>
        </div>

        <div class="auth-container" id="deleteAccountForm" style="display: none;">
            <div class="logo">üóëÔ∏è</div>
            <h1 style="color: #d32f2f;">Eliminar Cuenta</h1>
            <p class="subtitle">Esta acci√≥n no se puede deshacer</p>
            
            <div class="error-msg" id="deleteError"></div>
            <div class="success-msg" id="deleteSuccess"></div>
            
            <div class="form-group">
                <label for="deleteName">Nombre de usuario</label>
                <input type="text" id="deleteName" placeholder="Nombre de la cuenta a eliminar" maxlength="20">
            </div>
            
            <div class="form-group">
                <label for="deletePin">PIN (4 d√≠gitos)</label>
                <input type="password" id="deletePin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" pattern="[0-9]*" inputmode="numeric">
            </div>
            
            <button class="btn btn-danger" onclick="deleteAccount()">Eliminar Cuenta Permanentemente</button>
            <button class="btn btn-secondary" onclick="showLogin()">Cancelar</button>
        </div>

        <div class="auth-container" id="registerForm" style="display: none;">
            <div class="logo">‚ú®</div>
            <h1>√önete</h1>
            <p class="subtitle">Crea tu cuenta FamilyChat</p>
            
            <div class="error-msg" id="registerError"></div>
            <div class="success-msg" id="registerSuccess"></div>
            
            <div class="form-group">
                <label for="registerName">Nombre de usuario</label>
                <input type="text" id="registerName" placeholder="Tu nombre" maxlength="20">
            </div>
            
            <div class="form-group">
                <label for="registerPin">PIN (4 d√≠gitos)</label>
                <input type="password" id="registerPin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" pattern="[0-9]*" inputmode="numeric">
            </div>
            
            <div class="form-group">
                <label for="confirmPin">Confirmar PIN</label>
                <input type="password" id="confirmPin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" pattern="[0-9]*" inputmode="numeric">
            </div>
            
            <button class="btn btn-primary" onclick="register()">Crear Cuenta</button>
            <button class="btn btn-secondary" onclick="showLogin()">Ya tengo cuenta</button>
        </div>
    </div>

    <!-- Chat App -->
    <div class="chat-app" id="chatApp">
        <div class="chat-header">
            <h2>‚òéÔ∏è FamilyChat</h2>
            <div class="user-info">
                <span class="user-name" id="currentUserName"></span>
                <button class="btn-logout" onclick="logout()">Salir</button>
            </div>
        </div>
        
        <div class="chat-body">
            <div class="contacts-sidebar" id="contactsSidebar">
                <div class="tab-container">
                    <button class="tab-btn active" onclick="switchTab('private')" id="tabPrivate">üí¨ Chats</button>
                    <button class="tab-btn" onclick="switchTab('group')" id="tabGroup">üë• Familia</button>
                </div>
                <div class="contacts-header">Chats</div>
                <div id="contactsList"></div>
            </div>
            
            <div class="chat-area" id="chatArea">
                <div class="no-chat-selected" id="noChatSelected">
                    <div class="icon">üí¨</div>
                    <h3>FamilyChat Web</h3>
                    <p>Selecciona un chat para empezar</p>
                </div>
                
                <div id="activeChatContainer" style="display: none; flex-direction: column; height: 100%;">
                    <div class="chat-area-header" id="chatAreaHeader">
                        <button class="btn-back" onclick="closeChat()">‚Üê</button>
                        <div class="contact-avatar" id="chatAvatar">A</div>
                        <div class="contact-info">
                            <div class="contact-name" id="chatContactName">Usuario</div>
                            <div class="contact-status">en l√≠nea</div>
                        </div>
                    </div>
                    
                    <div class="messages-container" id="messagesContainer"></div>
                    
                    <div class="message-input-container">
                        <input type="text" class="message-input" id="messageInput" placeholder="Escribe un mensaje..." onkeypress="handleKeyPress(event)">
                        <button class="btn-send" onclick="sendMessage()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD8mv-bHquGuPpex8iQfgSY5E_VkPKyjts",
            authDomain: "familychat-30c91.firebaseapp.com",
            databaseURL: "https://familychat-30c91-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "familychat-30c91",
            storageBucket: "familychat-30c91.firebasestorage.app",
            messagingSenderId: "116925941490",
            appId: "1:116925941490:web:f57cafb64a49ab77c6b26b"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Database references
        const usersRef = database.ref('users');
        const messagesRef = database.ref('messages');
        const groupMessagesRef = database.ref('groupMessages');

        let currentUser = null;
        let selectedChat = null;
        let currentTab = 'private';
        let messagesListener = null;
        let groupMessagesListener = null;
        let usersListener = null;

        // Initialize
        function init() {
            // Check if user is already logged in (persiste en el dispositivo)
            const savedUser = localStorage.getItem('familychat_current_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showChatApp();
            }
        }

        // Show/Hide forms
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('deleteAccountForm').style.display = 'none';
            clearMessages();
        }

        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('deleteAccountForm').style.display = 'none';
            clearMessages();
        }

        function showDeleteAccount() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('deleteAccountForm').style.display = 'block';
            clearMessages();
        }

        function clearMessages() {
            document.querySelectorAll('.error-msg, .success-msg').forEach(el => {
                el.style.display = 'none';
            });
        }

        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.style.display = 'block';
        }

        function showSuccess(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.style.display = 'block';
        }

        // Register
        async function register() {
            clearMessages();
            const name = document.getElementById('registerName').value.trim();
            const pin = document.getElementById('registerPin').value;
            const confirmPin = document.getElementById('confirmPin').value;

            if (!name) {
                showError('registerError', 'Por favor ingresa un nombre');
                return;
            }

            if (name.length < 2) {
                showError('registerError', 'El nombre debe tener al menos 2 caracteres');
                return;
            }

            if (!/^\d{4}$/.test(pin)) {
                showError('registerError', 'El PIN debe ser de 4 d√≠gitos');
                return;
            }

            if (pin !== confirmPin) {
                showError('registerError', 'Los PINs no coinciden');
                return;
            }

            try {
                // Check if user exists
                const snapshot = await usersRef.orderByChild('nameLower').equalTo(name.toLowerCase()).once('value');
                
                if (snapshot.exists()) {
                    showError('registerError', 'Este nombre ya est√° registrado');
                    return;
                }

                // Create new user
                const newUserRef = usersRef.push();
                const newUser = {
                    id: newUserRef.key,
                    name: name,
                    nameLower: name.toLowerCase(),
                    pin: pin,
                    createdAt: new Date().toISOString()
                };

                await newUserRef.set(newUser);

                showSuccess('registerSuccess', '¬°Cuenta creada! Ahora puedes iniciar sesi√≥n');
                
                document.getElementById('registerName').value = '';
                document.getElementById('registerPin').value = '';
                document.getElementById('confirmPin').value = '';

                setTimeout(() => {
                    showLogin();
                    document.getElementById('loginName').value = name;
                }, 1500);
            } catch (error) {
                console.error('Error al registrar:', error);
                showError('registerError', 'Error al crear la cuenta. Intenta de nuevo.');
            }
        }

        // Delete Account
        async function deleteAccount() {
            clearMessages();
            const name = document.getElementById('deleteName').value.trim();
            const pin = document.getElementById('deletePin').value;

            if (!name || !pin) {
                showError('deleteError', 'Por favor completa todos los campos');
                return;
            }

            try {
                const snapshot = await usersRef.orderByChild('nameLower').equalTo(name.toLowerCase()).once('value');
                
                let userKey = null;
                let userId = null;
                snapshot.forEach((child) => {
                    if (child.val().pin === pin) {
                        userKey = child.key;
                        userId = child.val().id;
                    }
                });

                if (!userKey) {
                    showError('deleteError', 'Nombre o PIN incorrectos');
                    return;
                }

                // Delete user's private messages
                const messagesSnapshot = await messagesRef.once('value');
                if (messagesSnapshot.exists()) {
                    const deletePromises = [];
                    messagesSnapshot.forEach((child) => {
                        const msg = child.val();
                        if (msg.from === userId || msg.to === userId) {
                            deletePromises.push(messagesRef.child(child.key).remove());
                        }
                    });
                    await Promise.all(deletePromises);
                }

                // Delete user's group messages
                const groupSnapshot = await groupMessagesRef.once('value');
                if (groupSnapshot.exists()) {
                    const deletePromises = [];
                    groupSnapshot.forEach((child) => {
                        const msg = child.val();
                        if (msg.from === userId) {
                            deletePromises.push(groupMessagesRef.child(child.key).remove());
                        }
                    });
                    await Promise.all(deletePromises);
                }

                // Delete the user
                await usersRef.child(userKey).remove();

                showSuccess('deleteSuccess', '¬°Cuenta eliminada correctamente!');
                
                document.getElementById('deleteName').value = '';
                document.getElementById('deletePin').value = '';

                setTimeout(() => {
                    showLogin();
                }, 2000);
            } catch (error) {
                console.error('Error al eliminar cuenta:', error);
                showError('deleteError', 'Error al eliminar la cuenta. Intenta de nuevo.');
            }
        }

        // Login
        async function login() {
            clearMessages();
            const name = document.getElementById('loginName').value.trim();
            const pin = document.getElementById('loginPin').value;

            if (!name || !pin) {
                showError('loginError', 'Por favor completa todos los campos');
                return;
            }

            try {
                const snapshot = await usersRef.orderByChild('nameLower').equalTo(name.toLowerCase()).once('value');
                
                let user = null;
                snapshot.forEach((child) => {
                    if (child.val().pin === pin) {
                        user = child.val();
                    }
                });

                if (!user) {
                    showError('loginError', 'Nombre o PIN incorrectos');
                    return;
                }

                currentUser = user;
                localStorage.setItem('familychat_current_user', JSON.stringify(user));
                
                showChatApp();
            } catch (error) {
                console.error('Error al iniciar sesi√≥n:', error);
                showError('loginError', 'Error de conexi√≥n. Intenta de nuevo.');
            }
        }

        // Logout
        function logout() {
            // Remove listeners
            if (messagesListener) {
                messagesRef.off('value', messagesListener);
            }
            if (groupMessagesListener) {
                groupMessagesRef.off('value', groupMessagesListener);
            }
            if (usersListener) {
                usersRef.off('value', usersListener);
            }

            currentUser = null;
            selectedChat = null;
            localStorage.removeItem('familychat_current_user');

            document.getElementById('chatApp').style.display = 'none';
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('loginName').value = '';
            document.getElementById('loginPin').value = '';
            showLogin();
        }

        // Show Chat App
        function showChatApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('chatApp').style.display = 'flex';
            document.getElementById('currentUserName').textContent = currentUser.name;
            
            // Set up real-time listeners
            setupUsersListener();
            setupMessagesListener();
            setupGroupMessagesListener();
        }

        // Setup Users Listener
        function setupUsersListener() {
            usersListener = usersRef.on('value', (snapshot) => {
                loadContacts(snapshot);
            });
        }

        // Setup Messages Listener
        function setupMessagesListener() {
            messagesListener = messagesRef.on('value', (snapshot) => {
                if (selectedChat && currentTab === 'private') {
                    loadMessages(snapshot);
                }
                // Update unread badges
                usersRef.once('value').then(usersSnapshot => loadContacts(usersSnapshot));
            });
        }

        // Setup Group Messages Listener
        function setupGroupMessagesListener() {
            groupMessagesListener = groupMessagesRef.on('value', (snapshot) => {
                if (currentTab === 'group') {
                    loadGroupMessages(snapshot);
                }
            });
        }

        // Load Contacts
        function loadContacts(snapshot) {
            const contactsList = document.getElementById('contactsList');
            
            if (!snapshot || !snapshot.exists()) {
                contactsList.innerHTML = `
                    <div class="no-users-msg">
                        <p>üëã ¬°A√∫n no hay otros miembros!</p>
                        <p style="font-size: 14px; margin-top: 10px;">Comparte FamilyChat con tu familia para que puedan crear sus cuentas.</p>
                    </div>
                `;
                return;
            }

            const users = [];
            snapshot.forEach((child) => {
                const user = child.val();
                if (user.id !== currentUser.id) {
                    users.push(user);
                }
            });

            if (users.length === 0) {
                contactsList.innerHTML = `
                    <div class="no-users-msg">
                        <p>üëã ¬°A√∫n no hay otros miembros!</p>
                        <p style="font-size: 14px; margin-top: 10px;">Comparte FamilyChat con tu familia para que puedan crear sus cuentas.</p>
                    </div>
                `;
                return;
            }

            // Get unread counts
            messagesRef.once('value').then((messagesSnapshot) => {
                const unreadCounts = {};
                if (messagesSnapshot.exists()) {
                    messagesSnapshot.forEach((child) => {
                        const msg = child.val();
                        if (msg.to === currentUser.id && !msg.read) {
                            unreadCounts[msg.from] = (unreadCounts[msg.from] || 0) + 1;
                        }
                    });
                }

                contactsList.innerHTML = users.map(user => {
                    const unreadCount = unreadCounts[user.id] || 0;
                    const isActive = selectedChat && selectedChat.id === user.id && currentTab === 'private';

                    return `
                        <div class="contact-item ${isActive ? 'active' : ''}" onclick="selectChat('${user.id}')">
                            <div class="contact-avatar">${user.name.charAt(0).toUpperCase()}</div>
                            <div class="contact-info">
                                <div class="contact-name">${user.name}</div>
                                <div class="contact-status">Disponible</div>
                            </div>
                            ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                        </div>
                    `;
                }).join('');
            });
        }

        // Select Chat
        async function selectChat(userId) {
            const snapshot = await usersRef.child(userId).once('value');
            if (!snapshot.exists()) {
                // Try to find by id field
                const allUsers = await usersRef.once('value');
                allUsers.forEach((child) => {
                    if (child.val().id === userId) {
                        selectedChat = child.val();
                    }
                });
            } else {
                selectedChat = snapshot.val();
            }
            
            if (!selectedChat) {
                const allUsers = await usersRef.once('value');
                allUsers.forEach((child) => {
                    if (child.val().id === userId) {
                        selectedChat = child.val();
                    }
                });
            }
            
            currentTab = 'private';
            
            document.getElementById('tabPrivate').classList.add('active');
            document.getElementById('tabGroup').classList.remove('active');

            // Show chat area
            document.getElementById('chatArea').classList.add('active');
            document.getElementById('noChatSelected').style.display = 'none';
            document.getElementById('activeChatContainer').style.display = 'flex';
            
            document.getElementById('chatAvatar').textContent = selectedChat.name.charAt(0).toUpperCase();
            document.getElementById('chatContactName').textContent = selectedChat.name;

            // Mark messages as read
            await markMessagesAsRead(userId);
            
            // Load messages
            const messagesSnapshot = await messagesRef.once('value');
            loadMessages(messagesSnapshot);

            // Reload contacts to update badges
            const usersSnapshot = await usersRef.once('value');
            loadContacts(usersSnapshot);
        }

        // Close chat (mobile back button)
        function closeChat() {
            document.getElementById('chatArea').classList.remove('active');
            document.getElementById('activeChatContainer').style.display = 'none';
            selectedChat = null;
        }

        // Switch Tab
        function switchTab(tab) {
            currentTab = tab;
            
            if (tab === 'group') {
                document.getElementById('tabGroup').classList.add('active');
                document.getElementById('tabPrivate').classList.remove('active');
                selectedChat = null;
                
                // Show chat area
                document.getElementById('chatArea').classList.add('active');
                document.getElementById('noChatSelected').style.display = 'none';
                document.getElementById('activeChatContainer').style.display = 'flex';
                document.getElementById('chatAvatar').textContent = 'üë•';
                document.getElementById('chatContactName').textContent = 'Grupo Familiar';
                
                groupMessagesRef.once('value').then(snapshot => loadGroupMessages(snapshot));
            } else {
                document.getElementById('tabPrivate').classList.add('active');
                document.getElementById('tabGroup').classList.remove('active');
                
                if (!selectedChat) {
                    document.getElementById('chatArea').classList.remove('active');
                    document.getElementById('noChatSelected').style.display = 'flex';
                    document.getElementById('activeChatContainer').style.display = 'none';
                }
            }
            
            usersRef.once('value').then(snapshot => loadContacts(snapshot));

            if (window.innerWidth <= 768) {
                document.getElementById('contactsSidebar').classList.remove('show');
            }
        }

        // Mark messages as read
        async function markMessagesAsRead(userId) {
            const snapshot = await messagesRef.once('value');
            if (snapshot.exists()) {
                const updates = {};
                snapshot.forEach((child) => {
                    const msg = child.val();
                    if (msg.from === userId && msg.to === currentUser.id && !msg.read) {
                        updates[child.key + '/read'] = true;
                    }
                });
                if (Object.keys(updates).length > 0) {
                    await messagesRef.update(updates);
                }
            }
        }

        // Load Messages
        function loadMessages(snapshot) {
            if (!selectedChat) return;

            const container = document.getElementById('messagesContainer');
            const chatMessages = [];

            if (snapshot && snapshot.exists()) {
                snapshot.forEach((child) => {
                    const msg = child.val();
                    if ((msg.from === currentUser.id && msg.to === selectedChat.id) ||
                        (msg.from === selectedChat.id && msg.to === currentUser.id)) {
                        chatMessages.push(msg);
                    }
                });
            }

            chatMessages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            if (chatMessages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--wa-text-secondary); padding: 40px;">
                        <p>üëã ¬°Env√≠a el primer mensaje!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = chatMessages.map(m => {
                const isSent = m.from === currentUser.id;
                const time = new Date(m.timestamp).toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                return `
                    <div class="message ${isSent ? 'message-sent' : 'message-received'}">
                        <div class="message-text">${escapeHtml(m.text)}<span class="message-time">${time}</span></div>
                    </div>
                `;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        // Load Group Messages
        async function loadGroupMessages(snapshot) {
            const container = document.getElementById('messagesContainer');
            const groupMessages = [];

            if (snapshot && snapshot.exists()) {
                snapshot.forEach((child) => {
                    groupMessages.push(child.val());
                });
            }

            groupMessages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            if (groupMessages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #888; padding: 40px;">
                        <p>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ¬°Bienvenido al grupo familiar!</p>
                        <p style="font-size: 14px; margin-top: 10px;">Todos los mensajes aqu√≠ los ver√° toda la familia.</p>
                    </div>
                `;
                return;
            }

            // Get all users for names
            const usersSnapshot = await usersRef.once('value');
            const users = {};
            if (usersSnapshot.exists()) {
                usersSnapshot.forEach((child) => {
                    const user = child.val();
                    users[user.id] = user;
                });
            }

            container.innerHTML = groupMessages.map(m => {
                const isSent = m.from === currentUser.id;
                const sender = users[m.from];
                const senderName = sender ? sender.name : 'Usuario';
                const time = new Date(m.timestamp).toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                return `
                    <div class="message ${isSent ? 'message-sent' : 'message-received'}">
                        ${!isSent ? `<div class="message-sender">${escapeHtml(senderName)}</div>` : ''}
                        <div class="message-text">${escapeHtml(m.text)}<span class="message-time">${time}</span></div>
                    </div>
                `;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        // Send Message
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text) return;

            if (currentTab === 'group') {
                sendGroupMessage(text);
            } else if (selectedChat) {
                sendPrivateMessage(text);
            }

            input.value = '';
            input.focus();
        }

        async function sendPrivateMessage(text) {
            const newMessageRef = messagesRef.push();
            const newMessage = {
                id: newMessageRef.key,
                from: currentUser.id,
                to: selectedChat.id,
                text: text,
                timestamp: new Date().toISOString(),
                read: false
            };

            try {
                await newMessageRef.set(newMessage);
            } catch (error) {
                console.error('Error al enviar mensaje:', error);
                alert('Error al enviar el mensaje. Intenta de nuevo.');
            }
        }

        async function sendGroupMessage(text) {
            const newMessageRef = groupMessagesRef.push();
            const newMessage = {
                id: newMessageRef.key,
                from: currentUser.id,
                text: text,
                timestamp: new Date().toISOString()
            };

            try {
                await newMessageRef.set(newMessage);
            } catch (error) {
                console.error('Error al enviar mensaje:', error);
                alert('Error al enviar el mensaje. Intenta de nuevo.');
            }
        }

        // Handle Enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Toggle contacts on mobile
        function toggleContacts() {
            document.getElementById('contactsSidebar').classList.toggle('show');
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then((registration) => {
                        console.log('Service Worker registrado:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Error al registrar Service Worker:', error);
                    });
            });
        }

        // Initialize app
        init();
    </script>
</body>
</html>
