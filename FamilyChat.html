<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FamilyChat</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Chat familiar en tiempo real">
    <meta name="theme-color" content="#111B21">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FamilyChat">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons para iOS -->
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --wa-dark-green: #111B21;
            --wa-teal: #00A884;
            --wa-teal-dark: #008069;
            --wa-light-green: #D9FDD3;
            --wa-header: #202C33;
            --wa-chat-bg: #0B141A;
            --wa-input-bg: #2A3942;
            --wa-border: #222D34;
            --wa-text: #E9EDEF;
            --wa-text-secondary: #8696A0;
            --wa-bubble-out: #005C4B;
            --wa-bubble-in: #202C33;
            --wa-unread: #00A884;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            background: var(--wa-dark-green);
            touch-action: manipulation;
        }

        body {
            min-height: 100vh;
            min-height: 100dvh;
        }

        /* Auth Styles */
        .container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(180deg, var(--wa-teal-dark) 0%, var(--wa-teal-dark) 30%, var(--wa-dark-green) 30%);
            padding: 20px;
        }

        .auth-container {
            background: var(--wa-header);
            border-radius: 8px;
            padding: 35px 30px;
            width: 100%;
            max-width: 360px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }

        .auth-container h1 {
            text-align: center;
            color: var(--wa-text);
            margin-bottom: 6px;
            font-size: 1.6em;
            font-weight: 500;
        }

        .auth-container .subtitle {
            text-align: center;
            color: var(--wa-text-secondary);
            margin-bottom: 25px;
            font-size: 0.9em;
        }

        .auth-container .logo {
            text-align: center;
            font-size: 3em;
            margin-bottom: 12px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--wa-teal);
            font-weight: 400;
            font-size: 0.85em;
        }

        .form-group input {
            width: 100%;
            padding: 12px 14px;
            border: none;
            border-bottom: 2px solid var(--wa-border);
            font-size: 16px;
            background: transparent;
            color: var(--wa-text);
            transition: border-color 0.3s;
        }

        .form-group input::placeholder {
            color: var(--wa-text-secondary);
        }

        .form-group input:focus {
            outline: none;
            border-bottom-color: var(--wa-teal);
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 24px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--wa-teal);
            color: var(--wa-dark-green);
        }

        .btn-primary:active {
            background: var(--wa-teal-dark);
        }

        .btn-secondary {
            background: transparent;
            color: var(--wa-teal);
            border: 1px solid var(--wa-teal);
            margin-top: 10px;
        }

        .btn-danger {
            background: #EA4335;
            color: white;
        }

        .btn-link {
            background: none;
            border: none;
            color: #EA4335;
            cursor: pointer;
            font-size: 13px;
            margin-top: 18px;
            opacity: 0.9;
            width: auto;
            padding: 0;
        }

        .error-msg {
            background: rgba(234, 67, 53, 0.15);
            color: #FF6B6B;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 14px;
            text-align: center;
            display: none;
            font-size: 13px;
        }

        .success-msg {
            background: rgba(0, 168, 132, 0.15);
            color: var(--wa-teal);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 14px;
            text-align: center;
            display: none;
            font-size: 13px;
        }

        /* Chat App - Full screen */
        .chat-app {
            display: none;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            background: var(--wa-dark-green);
            overflow: hidden;
            flex-direction: column;
        }

        /* Main Header */
        .chat-header {
            background: var(--wa-header);
            color: var(--wa-text);
            padding: 10px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 56px;
            flex-shrink: 0;
        }

        .chat-header h2 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1em;
            font-weight: 500;
        }

        .chat-header .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header .user-name {
            font-weight: 400;
            font-size: 0.9em;
            color: var(--wa-text-secondary);
        }

        .btn-logout {
            background: transparent;
            color: var(--wa-text-secondary);
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.1);
            color: var(--wa-text);
        }

        .btn-toggle-contacts {
            background: none;
            border: none;
            color: var(--wa-text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s;
            display: none;
        }

        .btn-toggle-contacts:hover {
            background: rgba(255,255,255,0.1);
        }

        .chat-body {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* Contacts List - Full height */
        .contacts-sidebar {
            width: 100%;
            background: var(--wa-dark-green);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-container {
            display: flex;
            background: var(--wa-header);
            flex-shrink: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 14px 10px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 400;
            font-size: 14px;
            color: var(--wa-text-secondary);
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: var(--wa-teal);
            border-bottom-color: var(--wa-teal);
        }

        .contacts-header {
            padding: 18px 20px 10px;
            font-weight: 500;
            color: var(--wa-teal);
            font-size: 15px;
            flex-shrink: 0;
        }

        #contactsList {
            flex: 1;
            overflow-y: auto;
        }

        .contact-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid var(--wa-border);
        }

        .contact-item:hover {
            background: var(--wa-header);
        }

        .contact-item.active {
            background: var(--wa-input-bg);
        }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--wa-teal-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            font-size: 20px;
            flex-shrink: 0;
        }

        .contact-info {
            flex: 1;
            min-width: 0;
        }

        .contact-name {
            font-weight: 400;
            margin-bottom: 2px;
            color: var(--wa-text);
            font-size: 16px;
        }

        .contact-status {
            font-size: 13px;
            color: var(--wa-text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unread-badge {
            background: var(--wa-unread);
            color: var(--wa-dark-green);
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .no-users-msg {
            text-align: center;
            padding: 50px 25px;
            color: var(--wa-text-secondary);
        }

        .no-users-msg p:first-child {
            font-size: 16px;
            margin-bottom: 8px;
        }

        /* Chat Area - Full screen */
        .chat-area {
            display: none;
            flex-direction: column;
            background: var(--wa-chat-bg);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
        }

        .chat-area.active {
            display: flex;
        }

        .chat-area-header {
            padding: 10px 16px;
            background: var(--wa-header);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
            height: 56px;
        }

        .btn-back {
            background: none;
            border: none;
            color: var(--wa-text-secondary);
            font-size: 22px;
            cursor: pointer;
            padding: 6px;
            margin-right: 4px;
        }

        .chat-area-header .contact-avatar {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }

        .chat-area-header .contact-info {
            flex: 1;
        }

        .chat-area-header .contact-name {
            font-size: 16px;
            font-weight: 500;
        }

        .chat-area-header .contact-status {
            font-size: 12px;
            color: var(--wa-text-secondary);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 5L35 15L45 15L37 23L40 33L30 27L20 33L23 23L15 15L25 15Z' fill='%23ffffff' fill-opacity='0.02'/%3E%3C/svg%3E") var(--wa-chat-bg);
        }

        .message {
            max-width: 85%;
            padding: 6px 10px;
            border-radius: 8px;
            position: relative;
            margin: 1px 0;
        }

        .message-sent {
            align-self: flex-end;
            background: var(--wa-bubble-out);
            color: var(--wa-text);
            border-top-right-radius: 0;
        }

        .message-received {
            align-self: flex-start;
            background: var(--wa-bubble-in);
            color: var(--wa-text);
            border-top-left-radius: 0;
        }

        .message-sender {
            font-size: 12px;
            font-weight: 500;
            color: var(--wa-teal);
            margin-bottom: 2px;
        }

        .message-text {
            line-height: 1.35;
            font-size: 14.5px;
            word-wrap: break-word;
        }

        .message-time {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            text-align: right;
            margin-top: 2px;
            margin-left: 10px;
            float: right;
            margin-bottom: -4px;
        }

        .message-status {
            display: inline-block;
            margin-left: 4px;
            font-size: 14px;
            vertical-align: middle;
        }

        .message-status.sent {
            color: rgba(255,255,255,0.5);
        }

        .message-status.delivered {
            color: rgba(255,255,255,0.5);
        }

        .message-status.read {
            color: #53BDEB;
        }

        .message-input-container {
            padding: 8px 10px;
            background: var(--wa-header);
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }

        .message-input {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 24px;
            font-size: 15px;
            outline: none;
            background: var(--wa-input-bg);
            color: var(--wa-text);
        }

        .message-input::placeholder {
            color: var(--wa-text-secondary);
        }

        /* Bot√≥n de micr√≥fono */
        .btn-mic {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--wa-teal);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .btn-mic:active {
            background: var(--wa-teal-dark);
        }

        .btn-mic.recording {
            background: #E53935;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Audio en mensajes */
        .message-audio {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
            padding: 8px 0;
        }

        .audio-play-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--wa-teal);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .audio-wave {
            flex: 1;
            height: 30px;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .audio-wave span {
            width: 3px;
            background: rgba(255,255,255,0.5);
            border-radius: 2px;
        }

        .audio-duration {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            min-width: 35px;
        }

        /* Men√∫ contextual de mensaje */
        .message-menu {
            position: absolute;
            background: var(--wa-header);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            z-index: 1000;
            min-width: 150px;
            overflow: hidden;
            display: none;
        }

        .message-menu.show {
            display: block;
        }

        .message-menu-option {
            padding: 12px 16px;
            color: var(--wa-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .message-menu-option:hover {
            background: var(--wa-input-bg);
        }

        .message-menu-option.delete {
            color: #E53935;
        }

        /* Mensaje editado */
        .message-edited {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            font-style: italic;
            margin-right: 8px;
        }

        /* Mensaje eliminado */
        .message-deleted {
            font-style: italic;
            color: rgba(255,255,255,0.5);
        }

        /* Modal de edici√≥n */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .edit-modal.show {
            display: flex;
        }

        .edit-modal-content {
            background: var(--wa-header);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
        }

        .edit-modal h3 {
            color: var(--wa-text);
            margin-bottom: 16px;
            font-weight: 500;
        }

        .edit-modal input {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            background: var(--wa-input-bg);
            color: var(--wa-text);
            outline: none;
            margin-bottom: 16px;
        }

        .edit-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .edit-modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-cancel {
            background: var(--wa-input-bg);
            color: var(--wa-text);
        }

        .btn-save {
            background: var(--wa-teal);
            color: white;
        }

        /* Indicador de grabaci√≥n */
        .recording-indicator {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #E53935;
            padding: 12px 24px;
            border-radius: 24px;
            color: white;
            display: none;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            z-index: 100;
        }

        .recording-indicator.show {
            display: flex;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        /* Selector de emojis */
        .btn-emoji {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: transparent;
            color: var(--wa-text-secondary);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 24px;
        }

        .btn-emoji:hover {
            color: var(--wa-text);
        }

        .emoji-picker {
            position: absolute;
            bottom: 60px;
            left: 10px;
            background: var(--wa-header);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            width: 320px;
            max-height: 350px;
            display: none;
            flex-direction: column;
            z-index: 100;
            overflow: hidden;
        }

        .emoji-picker.show {
            display: flex;
        }

        .emoji-tabs {
            display: flex;
            border-bottom: 1px solid var(--wa-border);
            padding: 8px;
            gap: 4px;
        }

        .emoji-tab {
            flex: 1;
            padding: 8px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            opacity: 0.6;
        }

        .emoji-tab:hover, .emoji-tab.active {
            background: var(--wa-input-bg);
            opacity: 1;
        }

        .emoji-content {
            padding: 10px;
            overflow-y: auto;
            max-height: 280px;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
        }

        .emoji-item {
            padding: 6px;
            font-size: 22px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
        }

        .emoji-item:hover {
            background: var(--wa-input-bg);
        }

        @media (max-width: 400px) {
            .emoji-picker {
                width: calc(100vw - 20px);
                left: 10px;
                right: 10px;
            }
            .emoji-grid {
                grid-template-columns: repeat(7, 1fr);
            }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .btn-send {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--wa-teal);
            color: var(--wa-dark-green);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .btn-send:active {
            background: var(--wa-teal-dark);
        }

        .no-chat-selected {
            flex: 1;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--wa-text-secondary);
            padding: 20px;
            background: var(--wa-chat-bg);
        }

        .no-chat-selected .icon {
            font-size: 60px;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        .no-chat-selected h3 {
            color: var(--wa-text);
            font-weight: 400;
            margin-bottom: 8px;
        }

        /* Mobile - Default (contacts full screen, chat overlays) */
        @media (max-width: 768px) {
            .btn-toggle-contacts {
                display: none;
            }

            .contacts-sidebar {
                width: 100%;
            }

            .chat-area {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
            }

            /* === DISE√ëO GRANDE PARA M√ìVIL === */
            
            /* Header principal */
            .chat-header {
                height: 70px;
                padding: 14px 20px;
            }

            .chat-header h2 {
                font-size: 1.5em;
            }

            .btn-logout {
                font-size: 16px;
                padding: 12px 18px;
            }

            .user-name {
                font-size: 15px !important;
            }

            /* Pesta√±as */
            .tab-btn {
                padding: 18px 12px;
                font-size: 17px;
                font-weight: 500;
            }

            /* Header de contactos */
            .contacts-header {
                padding: 22px 20px 14px;
                font-size: 18px;
            }

            /* Lista de contactos */
            .contact-item {
                padding: 18px 20px;
                gap: 18px;
            }

            .contact-avatar {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }

            .contact-name {
                font-size: 19px;
                font-weight: 500;
            }

            .contact-status {
                font-size: 15px;
                margin-top: 3px;
            }

            .unread-badge {
                min-width: 26px;
                height: 26px;
                font-size: 14px;
                border-radius: 13px;
            }

            /* Mensaje de no usuarios */
            .no-users-msg {
                padding: 60px 30px;
            }

            .no-users-msg p:first-child {
                font-size: 20px;
            }

            /* Header del chat */
            .chat-area-header {
                height: 70px;
                padding: 14px 18px;
                gap: 16px;
            }

            .btn-back {
                font-size: 30px;
                padding: 8px;
            }

            .chat-area-header .contact-avatar {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .chat-area-header .contact-name {
                font-size: 19px;
                font-weight: 500;
            }

            .chat-area-header .contact-status {
                font-size: 14px;
            }

            /* √Årea de mensajes */
            .messages-container {
                padding: 16px 18px;
                gap: 4px;
            }

            .message {
                padding: 10px 14px;
                border-radius: 12px;
                max-width: 88%;
            }

            .message-text {
                font-size: 17px;
                line-height: 1.45;
            }

            .message-sender {
                font-size: 14px;
                margin-bottom: 4px;
            }

            .message-time {
                font-size: 13px;
            }

            /* Input de mensaje */
            .message-input-container {
                padding: 14px 16px;
                gap: 14px;
            }

            .message-input {
                padding: 14px 20px;
                font-size: 17px;
                border-radius: 26px;
            }

            .btn-send {
                width: 54px;
                height: 54px;
                font-size: 22px;
            }

            /* Auth containers para m√≥vil */
            .auth-container {
                padding: 40px 28px;
            }

            .auth-container .logo {
                font-size: 4em;
                margin-bottom: 16px;
            }

            .auth-container h1 {
                font-size: 2em;
                margin-bottom: 8px;
            }

            .auth-container .subtitle {
                font-size: 1.05em;
                margin-bottom: 30px;
            }

            .form-group {
                margin-bottom: 20px;
            }

            .form-group label {
                font-size: 0.95em;
                margin-bottom: 8px;
            }

            .form-group input {
                padding: 14px 16px;
                font-size: 17px;
            }

            .btn {
                padding: 15px;
                font-size: 17px;
                border-radius: 28px;
            }

            .btn-secondary {
                margin-top: 14px;
            }

            .btn-link {
                font-size: 15px;
                margin-top: 24px;
            }

            .error-msg, .success-msg {
                padding: 14px;
                font-size: 15px;
                margin-bottom: 18px;
            }
        }

        /* Tablet & Desktop */
        @media (min-width: 769px) {
            .chat-body {
                max-width: 1400px;
                margin: 0 auto;
                width: 100%;
            }

            .contacts-sidebar {
                width: 400px;
                max-width: 30%;
                border-right: 1px solid var(--wa-border);
                flex-shrink: 0;
            }

            .chat-area {
                position: relative;
                flex: 1;
                display: flex;
            }

            .chat-area.active {
                display: flex;
            }

            .no-chat-selected {
                display: flex;
            }

            .btn-back {
                display: none;
            }

            .chat-header .user-name {
                display: inline;
            }
        }

        @media (min-width: 1200px) {
            .contacts-sidebar {
                width: 420px;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div class="container" id="authContainer">
        <div class="auth-container" id="loginForm">
            <div class="logo">‚òéÔ∏è</div>
            <h1>FamilyChat</h1>
            <p class="subtitle">Conecta con tu familia</p>
            
            <div class="error-msg" id="loginError"></div>
            <div class="success-msg" id="loginSuccess"></div>
            
            <div class="form-group">
                <label for="loginName">Nombre de usuario</label>
                <input type="text" id="loginName" placeholder="Tu nombre" maxlength="20">
            </div>
            
            <div class="form-group">
                <label for="loginPin">PIN (4 d√≠gitos)</label>
                <input type="password" id="loginPin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" pattern="[0-9]*" inputmode="numeric">
            </div>
            
            <button class="btn btn-primary" onclick="login()">Iniciar Sesi√≥n</button>
            <button class="btn btn-secondary" onclick="showRegister()">Crear Cuenta Nueva</button>
            <button class="btn-link" onclick="showDeleteAccount()">Eliminar una cuenta</button>
        </div>

        <div class="auth-container" id="deleteAccountForm" style="display: none;">
            <div class="logo">üóëÔ∏è</div>
            <h1 style="color: #d32f2f;">Eliminar Cuenta</h1>
            <p class="subtitle">Esta acci√≥n no se puede deshacer</p>
            
            <div class="error-msg" id="deleteError"></div>
            <div class="success-msg" id="deleteSuccess"></div>
            
            <div class="form-group">
                <label for="deleteName">Nombre de usuario</label>
                <input type="text" id="deleteName" placeholder="Nombre de la cuenta a eliminar" maxlength="20">
            </div>
            
            <div class="form-group">
                <label for="deletePin">PIN (4 d√≠gitos)</label>
                <input type="password" id="deletePin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" pattern="[0-9]*" inputmode="numeric">
            </div>
            
            <button class="btn btn-danger" onclick="deleteAccount()">Eliminar Cuenta Permanentemente</button>
            <button class="btn btn-secondary" onclick="showLogin()">Cancelar</button>
        </div>

        <div class="auth-container" id="registerForm" style="display: none;">
            <div class="logo">‚ú®</div>
            <h1>√önete</h1>
            <p class="subtitle">Crea tu cuenta FamilyChat</p>
            
            <div class="error-msg" id="registerError"></div>
            <div class="success-msg" id="registerSuccess"></div>
            
            <div class="form-group">
                <label for="registerName">Nombre de usuario</label>
                <input type="text" id="registerName" placeholder="Tu nombre" maxlength="20">
            </div>
            
            <div class="form-group">
                <label for="registerPin">PIN (4 d√≠gitos)</label>
                <input type="password" id="registerPin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" pattern="[0-9]*" inputmode="numeric">
            </div>
            
            <div class="form-group">
                <label for="confirmPin">Confirmar PIN</label>
                <input type="password" id="confirmPin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" pattern="[0-9]*" inputmode="numeric">
            </div>
            
            <button class="btn btn-primary" onclick="register()">Crear Cuenta</button>
            <button class="btn btn-secondary" onclick="showLogin()">Ya tengo cuenta</button>
        </div>
    </div>

    <!-- Chat App -->
    <div class="chat-app" id="chatApp">
        <div class="chat-header">
            <h2>‚òéÔ∏è FamilyChat</h2>
            <div class="user-info">
                <span class="user-name" id="currentUserName"></span>
                <button class="btn-logout" onclick="logout()">Salir</button>
            </div>
        </div>
        
        <div class="chat-body">
            <div class="contacts-sidebar" id="contactsSidebar">
                <div class="tab-container">
                    <button class="tab-btn active" onclick="switchTab('private')" id="tabPrivate">üí¨ Chats</button>
                    <button class="tab-btn" onclick="switchTab('group')" id="tabGroup">üë• Familia</button>
                </div>
                <div class="contacts-header">Chats</div>
                <div id="contactsList"></div>
            </div>
            
            <div class="chat-area" id="chatArea">
                <div class="no-chat-selected" id="noChatSelected">
                    <div class="icon">üí¨</div>
                    <h3>FamilyChat Web</h3>
                    <p>Selecciona un chat para empezar</p>
                </div>
                
                <div id="activeChatContainer" style="display: none; flex-direction: column; height: 100%;">
                    <div class="chat-area-header" id="chatAreaHeader">
                        <button class="btn-back" onclick="closeChat()">‚Üê</button>
                        <div class="contact-avatar" id="chatAvatar">A</div>
                        <div class="contact-info">
                            <div class="contact-name" id="chatContactName">Usuario</div>
                            <div class="contact-status">en l√≠nea</div>
                        </div>
                    </div>
                    
                    <div class="messages-container" id="messagesContainer"></div>
                    
                    <div class="message-input-container">
                        <button class="btn-emoji" onclick="toggleEmojiPicker()">üòä</button>
                        <div class="emoji-picker" id="emojiPicker">
                            <div class="emoji-tabs">
                                <button class="emoji-tab active" onclick="showEmojiCategory('smileys')" data-category="smileys">üòÄ</button>
                                <button class="emoji-tab" onclick="showEmojiCategory('gestures')" data-category="gestures">üëã</button>
                                <button class="emoji-tab" onclick="showEmojiCategory('hearts')" data-category="hearts">‚ù§Ô∏è</button>
                                <button class="emoji-tab" onclick="showEmojiCategory('animals')" data-category="animals">üê∂</button>
                                <button class="emoji-tab" onclick="showEmojiCategory('food')" data-category="food">üçï</button>
                                <button class="emoji-tab" onclick="showEmojiCategory('objects')" data-category="objects">‚öΩ</button>
                            </div>
                            <div class="emoji-content">
                                <div class="emoji-grid" id="emojiGrid"></div>
                            </div>
                        </div>
                        <input type="text" class="message-input" id="messageInput" placeholder="Escribe un mensaje..." onkeypress="handleKeyPress(event)" oninput="toggleSendMicButton()">
                        <button class="btn-send" id="btnSend" onclick="sendMessage()" style="display: none;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z"/>
                            </svg>
                        </button>
                        <button class="btn-mic" id="btnMic" onclick="toggleRecording()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Men√∫ contextual -->
    <div class="message-menu" id="messageMenu">
        <div class="message-menu-option" onclick="editMessage()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            <span>Editar</span>
        </div>
        <div class="message-menu-option delete" onclick="deleteMessage()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
            <span>Eliminar</span>
        </div>
    </div>

    <!-- Modal de edici√≥n -->
    <div class="edit-modal" id="editModal">
        <div class="edit-modal-content">
            <h3>Editar mensaje</h3>
            <input type="text" id="editInput" placeholder="Escribe el nuevo mensaje...">
            <div class="edit-modal-buttons">
                <button class="btn-cancel" onclick="closeEditModal()">Cancelar</button>
                <button class="btn-save" onclick="saveEditedMessage()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Indicador de grabaci√≥n -->
    <div class="recording-indicator" id="recordingIndicator">
        <div class="recording-dot"></div>
        <span id="recordingTime">0:00</span>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD8mv-bHquGuPpex8iQfgSY5E_VkPKyjts",
            authDomain: "familychat-30c91.firebaseapp.com",
            databaseURL: "https://familychat-30c91-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "familychat-30c91",
            storageBucket: "familychat-30c91.firebasestorage.app",
            messagingSenderId: "116925941490",
            appId: "1:116925941490:web:f57cafb64a49ab77c6b26b"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Database references
        const usersRef = database.ref('users');
        const messagesRef = database.ref('messages');
        const groupMessagesRef = database.ref('groupMessages');

        let currentUser = null;
        let selectedChat = null;
        let currentTab = 'private';
        let messagesListener = null;
        let groupMessagesListener = null;
        let usersListener = null;
        let usersCache = {};

        // Variables para grabaci√≥n de audio
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let recordingStartTime = null;
        let recordingTimer = null;

        // Variables para edici√≥n/eliminaci√≥n de mensajes
        let selectedMessageId = null;
        let selectedMessageType = null; // 'private' o 'group'

        // Initialize
        function init() {
            // Check if user is already logged in (persiste en el dispositivo)
            try {
                const savedUser = localStorage.getItem('familychat_current_user');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    // Verificar que el usuario a√∫n existe en la base de datos
                    verifyAndShowChat();
                }
            } catch (e) {
                console.error('Error al inicializar:', e);
                localStorage.removeItem('familychat_current_user');
            }
        }

        // Verificar usuario y mostrar chat
        async function verifyAndShowChat() {
            try {
                // Intentar conectar con Firebase con timeout
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout')), 10000)
                );
                
                const checkPromise = usersRef.once('value');
                
                await Promise.race([checkPromise, timeoutPromise]);
                
                // Si llegamos aqu√≠, hay conexi√≥n
                showChatApp();
            } catch (e) {
                console.error('Error de conexi√≥n:', e);
                // Mostrar de todos modos, Firebase se reconectar√°
                showChatApp();
            }
        }

        // Show/Hide forms
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('deleteAccountForm').style.display = 'none';
            clearMessages();
        }

        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('deleteAccountForm').style.display = 'none';
            clearMessages();
        }

        function showDeleteAccount() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('deleteAccountForm').style.display = 'block';
            clearMessages();
        }

        function clearMessages() {
            document.querySelectorAll('.error-msg, .success-msg').forEach(el => {
                el.style.display = 'none';
            });
        }

        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.style.display = 'block';
        }

        function showSuccess(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.style.display = 'block';
        }

        // Register
        async function register() {
            clearMessages();
            const name = document.getElementById('registerName').value.trim();
            const pin = document.getElementById('registerPin').value;
            const confirmPin = document.getElementById('confirmPin').value;

            if (!name) {
                showError('registerError', 'Por favor ingresa un nombre');
                return;
            }

            if (name.length < 2) {
                showError('registerError', 'El nombre debe tener al menos 2 caracteres');
                return;
            }

            if (!/^\d{4}$/.test(pin)) {
                showError('registerError', 'El PIN debe ser de 4 d√≠gitos');
                return;
            }

            if (pin !== confirmPin) {
                showError('registerError', 'Los PINs no coinciden');
                return;
            }

            try {
                // Check if user exists
                const snapshot = await usersRef.orderByChild('nameLower').equalTo(name.toLowerCase()).once('value');
                
                if (snapshot.exists()) {
                    showError('registerError', 'Este nombre ya est√° registrado');
                    return;
                }

                // Create new user
                const newUserRef = usersRef.push();
                const newUser = {
                    id: newUserRef.key,
                    name: name,
                    nameLower: name.toLowerCase(),
                    pin: pin,
                    createdAt: new Date().toISOString()
                };

                await newUserRef.set(newUser);

                showSuccess('registerSuccess', '¬°Cuenta creada! Ahora puedes iniciar sesi√≥n');
                
                document.getElementById('registerName').value = '';
                document.getElementById('registerPin').value = '';
                document.getElementById('confirmPin').value = '';

                setTimeout(() => {
                    showLogin();
                    document.getElementById('loginName').value = name;
                }, 1500);
            } catch (error) {
                console.error('Error al registrar:', error);
                showError('registerError', 'Error al crear la cuenta. Intenta de nuevo.');
            }
        }

        // Delete Account
        async function deleteAccount() {
            clearMessages();
            const name = document.getElementById('deleteName').value.trim();
            const pin = document.getElementById('deletePin').value;

            if (!name || !pin) {
                showError('deleteError', 'Por favor completa todos los campos');
                return;
            }

            try {
                const snapshot = await usersRef.orderByChild('nameLower').equalTo(name.toLowerCase()).once('value');
                
                let userKey = null;
                let userId = null;
                snapshot.forEach((child) => {
                    if (child.val().pin === pin) {
                        userKey = child.key;
                        userId = child.val().id;
                    }
                });

                if (!userKey) {
                    showError('deleteError', 'Nombre o PIN incorrectos');
                    return;
                }

                // Delete user's private messages
                const messagesSnapshot = await messagesRef.once('value');
                if (messagesSnapshot.exists()) {
                    const deletePromises = [];
                    messagesSnapshot.forEach((child) => {
                        const msg = child.val();
                        if (msg.from === userId || msg.to === userId) {
                            deletePromises.push(messagesRef.child(child.key).remove());
                        }
                    });
                    await Promise.all(deletePromises);
                }

                // Delete user's group messages
                const groupSnapshot = await groupMessagesRef.once('value');
                if (groupSnapshot.exists()) {
                    const deletePromises = [];
                    groupSnapshot.forEach((child) => {
                        const msg = child.val();
                        if (msg.from === userId) {
                            deletePromises.push(groupMessagesRef.child(child.key).remove());
                        }
                    });
                    await Promise.all(deletePromises);
                }

                // Delete the user
                await usersRef.child(userKey).remove();

                showSuccess('deleteSuccess', '¬°Cuenta eliminada correctamente!');
                
                document.getElementById('deleteName').value = '';
                document.getElementById('deletePin').value = '';

                setTimeout(() => {
                    showLogin();
                }, 2000);
            } catch (error) {
                console.error('Error al eliminar cuenta:', error);
                showError('deleteError', 'Error al eliminar la cuenta. Intenta de nuevo.');
            }
        }

        // Login
        async function login() {
            clearMessages();
            const name = document.getElementById('loginName').value.trim();
            const pin = document.getElementById('loginPin').value;

            if (!name || !pin) {
                showError('loginError', 'Por favor completa todos los campos');
                return;
            }

            try {
                const snapshot = await usersRef.orderByChild('nameLower').equalTo(name.toLowerCase()).once('value');
                
                let user = null;
                snapshot.forEach((child) => {
                    if (child.val().pin === pin) {
                        user = child.val();
                    }
                });

                if (!user) {
                    showError('loginError', 'Nombre o PIN incorrectos');
                    return;
                }

                currentUser = user;
                localStorage.setItem('familychat_current_user', JSON.stringify(user));
                
                showChatApp();
            } catch (error) {
                console.error('Error al iniciar sesi√≥n:', error);
                showError('loginError', 'Error de conexi√≥n. Intenta de nuevo.');
            }
        }

        // Logout
        function logout() {
            // Remove listeners
            if (messagesListener) {
                messagesRef.off('value', messagesListener);
            }
            if (groupMessagesListener) {
                groupMessagesRef.off('value', groupMessagesListener);
            }
            if (usersListener) {
                usersRef.off('value', usersListener);
            }

            currentUser = null;
            selectedChat = null;
            localStorage.removeItem('familychat_current_user');

            document.getElementById('chatApp').style.display = 'none';
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('loginName').value = '';
            document.getElementById('loginPin').value = '';
            showLogin();
        }

        // Show Chat App
        function showChatApp() {
            try {
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('chatApp').style.display = 'flex';
                document.getElementById('currentUserName').textContent = currentUser.name;
                
                // Set up real-time listeners (esto tambi√©n marca mensajes como entregados)
                setupUsersListener();
                setupMessagesListener();
                setupGroupMessagesListener();
                
            } catch (e) {
                console.error('Error al mostrar chat:', e);
            }
        }

        // Setup Users Listener
        function setupUsersListener() {
            usersListener = usersRef.on('value', (snapshot) => {
                loadContacts(snapshot);
                // Actualizar cach√© de usuarios
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const user = child.val();
                        usersCache[user.id] = user;
                    });
                }
            });
        }

        // Setup Messages Listener
        function setupMessagesListener() {
            messagesListener = messagesRef.on('value', (snapshot) => {
                // Actualizar UI si estamos en un chat
                if (selectedChat && currentTab === 'private') {
                    loadMessages(snapshot);
                }
                
                // Marcar mensajes recibidos como entregados
                if (snapshot.exists()) {
                    snapshot.forEach((child) => {
                        const msg = child.val();
                        const msgKey = child.key;
                        
                        // Solo procesar mensajes que son para m√≠
                        if (msg.to === currentUser.id && msg.from !== currentUser.id) {
                            // Si el mensaje est√° en estado 'sent', marcarlo como 'delivered'
                            if (msg.status === 'sent') {
                                messagesRef.child(msgKey).update({ status: 'delivered' });
                            }
                        }
                    });
                }
                
                // Update unread badges
                usersRef.once('value').then(usersSnapshot => loadContacts(usersSnapshot));
            });
        }

        // Setup Group Messages Listener
        function setupGroupMessagesListener() {
            groupMessagesListener = groupMessagesRef.on('value', (snapshot) => {
                if (currentTab === 'group') {
                    loadGroupMessages(snapshot);
                }
            });
        }

        // Load Contacts
        function loadContacts(snapshot) {
            const contactsList = document.getElementById('contactsList');
            
            if (!snapshot || !snapshot.exists()) {
                contactsList.innerHTML = `
                    <div class="no-users-msg">
                        <p>üëã ¬°A√∫n no hay otros miembros!</p>
                        <p style="font-size: 14px; margin-top: 10px;">Comparte FamilyChat con tu familia para que puedan crear sus cuentas.</p>
                    </div>
                `;
                return;
            }

            const users = [];
            snapshot.forEach((child) => {
                const user = child.val();
                if (user.id !== currentUser.id) {
                    users.push(user);
                }
            });

            if (users.length === 0) {
                contactsList.innerHTML = `
                    <div class="no-users-msg">
                        <p>üëã ¬°A√∫n no hay otros miembros!</p>
                        <p style="font-size: 14px; margin-top: 10px;">Comparte FamilyChat con tu familia para que puedan crear sus cuentas.</p>
                    </div>
                `;
                return;
            }

            // Get unread counts
            messagesRef.once('value').then((messagesSnapshot) => {
                const unreadCounts = {};
                if (messagesSnapshot.exists()) {
                    messagesSnapshot.forEach((child) => {
                        const msg = child.val();
                        if (msg.to === currentUser.id && !msg.read) {
                            unreadCounts[msg.from] = (unreadCounts[msg.from] || 0) + 1;
                        }
                    });
                }

                contactsList.innerHTML = users.map(user => {
                    const unreadCount = unreadCounts[user.id] || 0;
                    const isActive = selectedChat && selectedChat.id === user.id && currentTab === 'private';

                    return `
                        <div class="contact-item ${isActive ? 'active' : ''}" onclick="selectChat('${user.id}')">
                            <div class="contact-avatar">${user.name.charAt(0).toUpperCase()}</div>
                            <div class="contact-info">
                                <div class="contact-name">${user.name}</div>
                                <div class="contact-status">Disponible</div>
                            </div>
                            ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                        </div>
                    `;
                }).join('');
            });
        }

        // Select Chat
        async function selectChat(userId) {
            const snapshot = await usersRef.child(userId).once('value');
            if (!snapshot.exists()) {
                // Try to find by id field
                const allUsers = await usersRef.once('value');
                allUsers.forEach((child) => {
                    if (child.val().id === userId) {
                        selectedChat = child.val();
                    }
                });
            } else {
                selectedChat = snapshot.val();
            }
            
            if (!selectedChat) {
                const allUsers = await usersRef.once('value');
                allUsers.forEach((child) => {
                    if (child.val().id === userId) {
                        selectedChat = child.val();
                    }
                });
            }
            
            currentTab = 'private';
            
            document.getElementById('tabPrivate').classList.add('active');
            document.getElementById('tabGroup').classList.remove('active');

            // Show chat area
            document.getElementById('chatArea').classList.add('active');
            document.getElementById('noChatSelected').style.display = 'none';
            document.getElementById('activeChatContainer').style.display = 'flex';
            
            document.getElementById('chatAvatar').textContent = selectedChat.name.charAt(0).toUpperCase();
            document.getElementById('chatContactName').textContent = selectedChat.name;

            // Mark messages as read
            await markMessagesAsRead(userId);
            
            // Load messages
            const messagesSnapshot = await messagesRef.once('value');
            loadMessages(messagesSnapshot);

            // Reload contacts to update badges
            const usersSnapshot = await usersRef.once('value');
            loadContacts(usersSnapshot);
        }

        // Close chat (mobile back button)
        function closeChat() {
            document.getElementById('chatArea').classList.remove('active');
            document.getElementById('activeChatContainer').style.display = 'none';
            selectedChat = null;
        }

        // Switch Tab
        function switchTab(tab) {
            currentTab = tab;
            
            if (tab === 'group') {
                document.getElementById('tabGroup').classList.add('active');
                document.getElementById('tabPrivate').classList.remove('active');
                selectedChat = null;
                
                // Show chat area
                document.getElementById('chatArea').classList.add('active');
                document.getElementById('noChatSelected').style.display = 'none';
                document.getElementById('activeChatContainer').style.display = 'flex';
                document.getElementById('chatAvatar').textContent = 'üë•';
                document.getElementById('chatContactName').textContent = 'Grupo Familiar';
                
                groupMessagesRef.once('value').then(snapshot => loadGroupMessages(snapshot));
            } else {
                document.getElementById('tabPrivate').classList.add('active');
                document.getElementById('tabGroup').classList.remove('active');
                
                if (!selectedChat) {
                    document.getElementById('chatArea').classList.remove('active');
                    document.getElementById('noChatSelected').style.display = 'flex';
                    document.getElementById('activeChatContainer').style.display = 'none';
                }
            }
            
            usersRef.once('value').then(snapshot => loadContacts(snapshot));

            if (window.innerWidth <= 768) {
                document.getElementById('contactsSidebar').classList.remove('show');
            }
        }

        // Mark messages as read (cuando abro un chat)
        async function markMessagesAsRead(userId) {
            const snapshot = await messagesRef.once('value');
            if (snapshot.exists()) {
                const updates = {};
                snapshot.forEach((child) => {
                    const msg = child.val();
                    if (msg.from === userId && msg.to === currentUser.id && !msg.read) {
                        updates[child.key + '/read'] = true;
                        updates[child.key + '/status'] = 'read';
                    }
                });
                if (Object.keys(updates).length > 0) {
                    await messagesRef.update(updates);
                }
            }
        }

        // Load Messages
        function loadMessages(snapshot) {
            if (!selectedChat) return;

            const container = document.getElementById('messagesContainer');
            const chatMessages = [];

            if (snapshot && snapshot.exists()) {
                snapshot.forEach((child) => {
                    const msg = child.val();
                    msg._key = child.key;
                    if ((msg.from === currentUser.id && msg.to === selectedChat.id) ||
                        (msg.from === selectedChat.id && msg.to === currentUser.id)) {
                        chatMessages.push(msg);
                    }
                });
            }

            chatMessages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            if (chatMessages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--wa-text-secondary); padding: 40px;">
                        <p>üëã ¬°Env√≠a el primer mensaje!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = chatMessages.map(m => {
                const isSent = m.from === currentUser.id;
                const time = new Date(m.timestamp).toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // Ticks de estado (solo para mensajes enviados)
                let statusIcon = '';
                if (isSent) {
                    if (m.read || m.status === 'read') {
                        statusIcon = '<span class="message-status read">‚úì‚úì</span>';
                    } else if (m.status === 'delivered') {
                        statusIcon = '<span class="message-status delivered">‚úì‚úì</span>';
                    } else {
                        statusIcon = '<span class="message-status sent">‚úì</span>';
                    }
                }

                // Indicador de editado
                const editedTag = m.edited ? '<span class="message-edited">editado</span>' : '';

                // Contenido del mensaje
                let content = '';
                if (m.deleted) {
                    content = `<div class="message-text message-deleted">üö´ Mensaje eliminado<span class="message-time">${time}</span></div>`;
                } else if (m.audioData) {
                    content = `
                        <div class="message-audio">
                            <button class="audio-play-btn" onclick="playAudio('${m._key}', 'private')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                            </button>
                            <div class="audio-wave">${generateWaveform()}</div>
                            <span class="audio-duration">${m.audioDuration || '0:00'}</span>
                        </div>
                        <audio id="audio-private-${m._key}" src="${m.audioData}" style="display:none;"></audio>
                        <div class="message-text"><span class="message-time">${editedTag}${time}${statusIcon}</span></div>
                    `;
                } else {
                    content = `<div class="message-text">${escapeHtml(m.text)}${editedTag}<span class="message-time">${time}${statusIcon}</span></div>`;
                }

                // Solo permitir men√∫ en mensajes propios no eliminados
                const menuAttr = isSent && !m.deleted ? `oncontextmenu="showMessageMenu(event, '${m._key}', 'private')" onclick="handleMessageClick(event, '${m._key}', 'private')"` : '';

                return `
                    <div class="message ${isSent ? 'message-sent' : 'message-received'}" ${menuAttr} data-msgid="${m._key}">
                        ${content}
                    </div>
                `;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        // Load Group Messages
        async function loadGroupMessages(snapshot) {
            const container = document.getElementById('messagesContainer');
            const groupMessages = [];

            if (snapshot && snapshot.exists()) {
                snapshot.forEach((child) => {
                    const msg = child.val();
                    msg._key = child.key;
                    groupMessages.push(msg);
                });
            }

            groupMessages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            if (groupMessages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #888; padding: 40px;">
                        <p>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ¬°Bienvenido al grupo familiar!</p>
                        <p style="font-size: 14px; margin-top: 10px;">Todos los mensajes aqu√≠ los ver√° toda la familia.</p>
                    </div>
                `;
                return;
            }

            // Get all users for names
            const usersSnapshot = await usersRef.once('value');
            const users = {};
            if (usersSnapshot.exists()) {
                usersSnapshot.forEach((child) => {
                    const user = child.val();
                    users[user.id] = user;
                });
            }

            container.innerHTML = groupMessages.map(m => {
                const isSent = m.from === currentUser.id;
                const sender = users[m.from];
                const senderName = sender ? sender.name : 'Usuario';
                const time = new Date(m.timestamp).toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                // Indicador de editado
                const editedTag = m.edited ? '<span class="message-edited">editado</span>' : '';

                // Contenido del mensaje
                let content = '';
                if (m.deleted) {
                    content = `<div class="message-text message-deleted">üö´ Mensaje eliminado<span class="message-time">${time}</span></div>`;
                } else if (m.audioData) {
                    content = `
                        <div class="message-audio">
                            <button class="audio-play-btn" onclick="playAudio('${m._key}', 'group')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                            </button>
                            <div class="audio-wave">${generateWaveform()}</div>
                            <span class="audio-duration">${m.audioDuration || '0:00'}</span>
                        </div>
                        <audio id="audio-group-${m._key}" src="${m.audioData}" style="display:none;"></audio>
                        <div class="message-text"><span class="message-time">${editedTag}${time}</span></div>
                    `;
                } else {
                    content = `<div class="message-text">${escapeHtml(m.text)}${editedTag}<span class="message-time">${time}</span></div>`;
                }

                // Solo permitir men√∫ en mensajes propios no eliminados
                const menuAttr = isSent && !m.deleted ? `oncontextmenu="showMessageMenu(event, '${m._key}', 'group')" onclick="handleMessageClick(event, '${m._key}', 'group')"` : '';

                return `
                    <div class="message ${isSent ? 'message-sent' : 'message-received'}" ${menuAttr} data-msgid="${m._key}">
                        ${!isSent ? `<div class="message-sender">${escapeHtml(senderName)}</div>` : ''}
                        ${content}
                    </div>
                `;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        // Send Message
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text) return;

            if (currentTab === 'group') {
                sendGroupMessage(text);
            } else if (selectedChat) {
                sendPrivateMessage(text);
            }

            input.value = '';
            input.focus();
        }

        async function sendPrivateMessage(text) {
            const newMessageRef = messagesRef.push();
            const newMessage = {
                id: newMessageRef.key,
                from: currentUser.id,
                to: selectedChat.id,
                text: text,
                timestamp: new Date().toISOString(),
                status: 'sent', // sent -> delivered -> read
                read: false
            };

            try {
                await newMessageRef.set(newMessage);
            } catch (error) {
                console.error('Error al enviar mensaje:', error);
                alert('Error al enviar el mensaje. Intenta de nuevo.');
            }
        }

        async function sendGroupMessage(text) {
            const newMessageRef = groupMessagesRef.push();
            const newMessage = {
                id: newMessageRef.key,
                from: currentUser.id,
                text: text,
                timestamp: new Date().toISOString()
            };

            try {
                await newMessageRef.set(newMessage);
            } catch (error) {
                console.error('Error al enviar mensaje:', error);
                alert('Error al enviar el mensaje. Intenta de nuevo.');
            }
        }

        // Handle Enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Toggle contacts on mobile
        function toggleContacts() {
            document.getElementById('contactsSidebar').classList.toggle('show');
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== FUNCIONES DE AUDIO ==========

        // Alternar entre bot√≥n enviar y micr√≥fono
        function toggleSendMicButton() {
            const input = document.getElementById('messageInput');
            const btnSend = document.getElementById('btnSend');
            const btnMic = document.getElementById('btnMic');
            
            if (input.value.trim()) {
                btnSend.style.display = 'flex';
                btnMic.style.display = 'none';
            } else {
                btnSend.style.display = 'none';
                btnMic.style.display = 'flex';
            }
        }

        // ========== SELECTOR DE EMOJIS ==========

        const emojiCategories = {
            smileys: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'ü§ê', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'üòÆ', 'ü§Ø', 'üò¥', 'ü•±', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ', 'ü§ß', 'ü•µ', 'ü•∂', 'üòµ', 'ü§†', 'ü•≥', 'ü•∏', 'üòé', 'ü§ì', 'üßê'],
            gestures: ['üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëå', 'ü§å', 'ü§è', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üñï', 'üëá', '‚òùÔ∏è', 'üëç', 'üëé', '‚úä', 'üëä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù', 'üôè', 'üí™', 'ü¶æ', 'ü¶ø', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ', 'üë∂', 'üëß', 'üßí', 'üë¶', 'üë©', 'üßë', 'üë®', 'üë¥', 'üëµ'],
            hearts: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚ô•Ô∏è', 'üíå', 'üíã', 'üëÑ', 'üëÖ', 'ü´¶', 'ü©∑', 'ü©µ', 'ü©∂'],
            animals: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üôà', 'üôâ', 'üôä', 'üêî', 'üêß', 'üê¶', 'üê§', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'üêõ', 'ü¶ã', 'üêå', 'üêû', 'üêú', 'ü¶ü', 'ü¶Ç', 'üê¢', 'üêç', 'ü¶é', 'üêô', 'ü¶ë', 'ü¶ê', 'ü¶û', 'ü¶Ä', 'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêã', 'ü¶à', 'üêä'],
            food: ['üçï', 'üçî', 'üçü', 'üå≠', 'üçø', 'üßÇ', 'ü•ì', 'ü•ö', 'üç≥', 'üßá', 'ü•û', 'üßà', 'üçû', 'ü•ê', 'ü•ñ', 'ü•®', 'üßÄ', 'ü•ó', 'ü•ô', 'üåÆ', 'üåØ', 'ü´î', 'ü•´', 'üçù', 'üçú', 'üç≤', 'üçõ', 'üç£', 'üç±', 'ü•ü', 'üç§', 'üçô', 'üçö', 'üçò', 'üç•', 'ü•†', 'üç¢', 'üç°', 'üçß', 'üç®', 'üç¶', 'ü•ß', 'üßÅ', 'üç∞', 'üéÇ', 'üçÆ', 'üç≠', 'üç¨', 'üç´', 'üç©', 'üç™', '‚òï', 'üçµ', 'üßÉ', 'ü•§', 'üç∫', 'üçª', 'ü•Ç', 'üç∑', 'ü•É'],
            objects: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'ü•è', 'üé±', 'üèì', 'üè∏', 'üèí', 'üèë', 'ü•ç', 'üèè', 'ü™É', 'ü•Ö', '‚õ≥', 'üèπ', 'üé£', 'ü§ø', 'ü•ä', 'ü•ã', 'üéΩ', 'üõπ', 'üõº', 'üõ∑', '‚õ∏Ô∏è', 'ü•å', 'üéø', 'üéÆ', 'üé≤', 'üé≠', 'üé®', 'üé¨', 'üé§', 'üéß', 'üéº', 'üéπ', 'ü•Å', 'üé∑', 'üé∫', 'üé∏', 'ü™ï', 'üéª', 'üì±', 'üíª', 'üñ•Ô∏è', 'üì∑', 'üì∏', 'üìπ', 'üé•', 'üì∫', 'üìª', 'üîä', 'üîî', 'üì£', 'üí°', 'üî¶', 'üïØÔ∏è']
        };

        let currentEmojiCategory = 'smileys';

        function toggleEmojiPicker() {
            event.stopPropagation();
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('show');
            if (picker.classList.contains('show')) {
                showEmojiCategory('smileys');
            }
        }

        function showEmojiCategory(category) {
            currentEmojiCategory = category;
            const grid = document.getElementById('emojiGrid');
            const emojis = emojiCategories[category] || [];
            
            grid.innerHTML = emojis.map(emoji => 
                `<button class="emoji-item" onclick="insertEmoji('${emoji}')">${emoji}</button>`
            ).join('');

            // Actualizar tabs activos
            document.querySelectorAll('.emoji-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.category === category);
            });
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            
            input.value = text.substring(0, start) + emoji + text.substring(end);
            input.focus();
            
            // Posicionar cursor despu√©s del emoji
            const newPos = start + emoji.length;
            input.setSelectionRange(newPos, newPos);
            
            // Actualizar bot√≥n enviar/mic
            toggleSendMicButton();
        }

        // Cerrar emoji picker al hacer clic fuera
        document.addEventListener('click', (e) => {
            const picker = document.getElementById('emojiPicker');
            if (!e.target.closest('.btn-emoji') && !e.target.closest('.emoji-picker')) {
                picker.classList.remove('show');
            }
        });

        // Iniciar/detener grabaci√≥n
        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function startRecording() {
            try {
                // Configurar audio con menor calidad para permitir grabaciones m√°s largas
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,      // 16kHz (suficiente para voz)
                        channelCount: 1,         // Mono
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                // Configurar MediaRecorder con baja tasa de bits
                const options = { 
                    mimeType: 'audio/webm;codecs=opus',
                    audioBitsPerSecond: 12000  // 12kbps - muy bajo pero claro para voz
                };
                
                // Fallback si el navegador no soporta las opciones
                try {
                    mediaRecorder = new MediaRecorder(stream, options);
                } catch (e) {
                    mediaRecorder = new MediaRecorder(stream);
                }
                
                audioChunks = [];

                mediaRecorder.ondataavailable = (e) => {
                    audioChunks.push(e.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    // Verificar tama√±o (m√°ximo ~900KB para Firebase)
                    if (audioBlob.size > 900000) {
                        alert('El audio es demasiado largo. M√°ximo ~3 minutos.');
                        stream.getTracks().forEach(track => track.stop());
                        return;
                    }
                    
                    // Convertir a base64
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const base64Audio = reader.result;
                        const duration = formatDuration((Date.now() - recordingStartTime) / 1000);
                        
                        // Enviar audio
                        if (currentTab === 'group') {
                            await sendGroupAudio(base64Audio, duration);
                        } else if (selectedChat) {
                            await sendPrivateAudio(base64Audio, duration);
                        }
                    };
                    reader.readAsDataURL(audioBlob);

                    // Detener todas las pistas
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();

                // UI
                document.getElementById('btnMic').classList.add('recording');
                document.getElementById('recordingIndicator').classList.add('show');
                updateRecordingTime();

            } catch (error) {
                console.error('Error al acceder al micr√≥fono:', error);
                alert('No se pudo acceder al micr√≥fono. Verifica los permisos.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                clearInterval(recordingTimer);

                document.getElementById('btnMic').classList.remove('recording');
                document.getElementById('recordingIndicator').classList.remove('show');
            }
        }

        function updateRecordingTime() {
            recordingTimer = setInterval(() => {
                const elapsed = (Date.now() - recordingStartTime) / 1000;
                document.getElementById('recordingTime').textContent = formatDuration(elapsed);
            }, 1000);
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        async function sendPrivateAudio(audioData, duration) {
            const newMessageRef = messagesRef.push();
            const newMessage = {
                id: newMessageRef.key,
                from: currentUser.id,
                to: selectedChat.id,
                text: '',
                audioData: audioData,
                audioDuration: duration,
                timestamp: new Date().toISOString(),
                status: 'sent',
                read: false
            };

            try {
                await newMessageRef.set(newMessage);
            } catch (error) {
                console.error('Error al enviar audio:', error);
                alert('Error al enviar el audio.');
            }
        }

        async function sendGroupAudio(audioData, duration) {
            const newMessageRef = groupMessagesRef.push();
            const newMessage = {
                id: newMessageRef.key,
                from: currentUser.id,
                text: '',
                audioData: audioData,
                audioDuration: duration,
                timestamp: new Date().toISOString()
            };

            try {
                await newMessageRef.set(newMessage);
            } catch (error) {
                console.error('Error al enviar audio:', error);
                alert('Error al enviar el audio.');
            }
        }

        // Generar ondas visuales para audio
        function generateWaveform() {
            let bars = '';
            for (let i = 0; i < 20; i++) {
                const height = Math.random() * 20 + 5;
                bars += `<span style="height: ${height}px;"></span>`;
            }
            return bars;
        }

        // Reproducir audio
        function playAudio(msgId, type) {
            const audio = document.getElementById(`audio-${type}-${msgId}`);
            if (audio) {
                if (audio.paused) {
                    audio.play();
                } else {
                    audio.pause();
                    audio.currentTime = 0;
                }
            }
        }

        // ========== FUNCIONES DE MEN√ö Y EDICI√ìN ==========

        let longPressTimer = null;

        function handleMessageClick(event, msgId, type) {
            // Para dispositivos t√°ctiles, usar long press
            // Para desktop, el contextmenu ya lo maneja
        }

        function showMessageMenu(event, msgId, type) {
            event.preventDefault();
            event.stopPropagation();
            
            selectedMessageId = msgId;
            selectedMessageType = type;

            const menu = document.getElementById('messageMenu');
            
            // Posicionar el men√∫
            let x = event.clientX || event.touches?.[0]?.clientX || 100;
            let y = event.clientY || event.touches?.[0]?.clientY || 100;

            // Ajustar si se sale de la pantalla
            if (x + 150 > window.innerWidth) x = window.innerWidth - 160;
            if (y + 100 > window.innerHeight) y = window.innerHeight - 110;

            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('show');
        }

        // Cerrar men√∫ al hacer clic fuera
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('messageMenu');
            if (!e.target.closest('.message-menu')) {
                menu.classList.remove('show');
            }
        });

        // Editar mensaje
        async function editMessage() {
            document.getElementById('messageMenu').classList.remove('show');
            
            // Obtener el texto actual del mensaje
            const ref = selectedMessageType === 'group' ? groupMessagesRef : messagesRef;
            const snapshot = await ref.child(selectedMessageId).once('value');
            const msg = snapshot.val();

            if (msg && msg.text && !msg.audioData) {
                document.getElementById('editInput').value = msg.text;
                document.getElementById('editModal').classList.add('show');
            } else if (msg.audioData) {
                alert('Los mensajes de audio no se pueden editar.');
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
            document.getElementById('editInput').value = '';
        }

        async function saveEditedMessage() {
            const newText = document.getElementById('editInput').value.trim();
            if (!newText) {
                alert('El mensaje no puede estar vac√≠o');
                return;
            }

            try {
                const ref = selectedMessageType === 'group' ? groupMessagesRef : messagesRef;
                await ref.child(selectedMessageId).update({
                    text: newText,
                    edited: true,
                    editedAt: new Date().toISOString()
                });
                closeEditModal();
            } catch (error) {
                console.error('Error al editar mensaje:', error);
                alert('Error al editar el mensaje.');
            }
        }

        // Eliminar mensaje
        async function deleteMessage() {
            document.getElementById('messageMenu').classList.remove('show');

            if (confirm('¬øEliminar este mensaje?')) {
                try {
                    const ref = selectedMessageType === 'group' ? groupMessagesRef : messagesRef;
                    await ref.child(selectedMessageId).update({
                        text: '',
                        audioData: null,
                        deleted: true,
                        deletedAt: new Date().toISOString()
                    });
                } catch (error) {
                    console.error('Error al eliminar mensaje:', error);
                    alert('Error al eliminar el mensaje.');
                }
            }
        }

        // Manejar long press en m√≥viles
        document.addEventListener('touchstart', (e) => {
            const msg = e.target.closest('.message-sent[data-msgid]');
            if (msg) {
                const msgId = msg.dataset.msgid;
                const type = currentTab === 'group' ? 'group' : 'private';
                longPressTimer = setTimeout(() => {
                    showMessageMenu(e, msgId, type);
                }, 500);
            }
        });

        document.addEventListener('touchend', () => {
            clearTimeout(longPressTimer);
        });

        document.addEventListener('touchmove', () => {
            clearTimeout(longPressTimer);
        });

        // Cerrar modal con Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeEditModal();
                document.getElementById('messageMenu').classList.remove('show');
            }
        });

        // Register Service Worker for PWA (no bloquea la app)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    navigator.serviceWorker.register('sw.js')
                        .then((registration) => {
                            console.log('SW registrado');
                        })
                        .catch((error) => {
                            console.log('SW error:', error);
                        });
                }, 2000);
            });
        }

        // Inicializar botones al cargar
        toggleSendMicButton();

        // Initialize app
        init();
    </script>
</body>
</html>
